using System;
using BepInEx.Configuration;
using HarmonyLib;
using Photon.Pun;
using TMPro;
using UnboundLib;
using UnboundLib.Networking;
using UnboundLib.Utils.UI;
using UnityEngine;
using System.Collections;

namespace TeamComposition2
{
    internal static class RespawnInvulnerabilityManager
    {
        private const string ModId = "com.adamklein.teamcomposition.respawninvuln";
        private const string MenuName = "Respawn Invulnerability";
        private const float MaxDuration = 5f;
        private const float MinDuration = 0f;
        private const float DefaultDuration = 1.5f;

        private static ConfigEntry<float> invulnerabilityDurationConfig;

        internal static float InvulnerabilityDuration { get; private set; }

        internal static void Initialize(ConfigFile config)
        {
            invulnerabilityDurationConfig = config.Bind(
                "Respawn",
                "InvulnerabilitySeconds",
                DefaultDuration,
                "Duration of post-respawn invulnerability in seconds."
            );

            SetDuration(invulnerabilityDurationConfig.Value, false);

            var harmony = new Harmony(ModId);
            harmony.PatchAll(typeof(HealthHandlerRevivePatch));
        }

        internal static void RegisterMenu()
        {
            Unbound.RegisterMenu(MenuName, () => { }, BuildMenu, null, true);
            Unbound.RegisterHandshake(ModId, OnHandshakeCompleted);
        }

        private static bool CanChangeSettings()
        {
            return !PhotonNetwork.IsConnected || PhotonNetwork.IsMasterClient;
        }

        private static void BuildMenu(GameObject menu)
        {
            MenuHandler.CreateText($"{MenuName} Options", menu, out TextMeshProUGUI _, 60);
            MenuHandler.CreateText(" ", menu, out TextMeshProUGUI warningText, 30, color: Color.red);

            void OnSliderChanged(float value)
            {
                if (!CanChangeSettings())
                {
                    warningText.text = "ONLY THE HOST CAN CHANGE THESE SETTINGS MID-GAME";
                    return;
                }

                warningText.text = " ";
                SetDuration(value, true);
            }

            MenuHandler.CreateSlider(
                "Invulnerability Time (seconds)",
                menu,
                30,
                MinDuration,
                MaxDuration,
                InvulnerabilityDuration,
                OnSliderChanged,
                out _);

            MenuHandler.CreateText(" ", menu, out TextMeshProUGUI _, 30);
        }

        private static void SetDuration(float value, bool broadcast)
        {
            InvulnerabilityDuration = Mathf.Clamp(value, MinDuration, MaxDuration);
            invulnerabilityDurationConfig.Value = InvulnerabilityDuration;

            if (broadcast && PhotonNetwork.IsMasterClient)
            {
                NetworkingManager.RPC_Others(typeof(RespawnInvulnerabilityManager), nameof(SyncSettings), InvulnerabilityDuration);
            }
        }

        private static void OnHandshakeCompleted()
        {
            if (PhotonNetwork.IsMasterClient)
            {
                NetworkingManager.RPC_Others(typeof(RespawnInvulnerabilityManager), nameof(SyncSettings), InvulnerabilityDuration);
            }
        }

        [UnboundRPC]
        private static void SyncSettings(float duration)
        {
            SetDuration(duration, false);
        }

        internal static void TryApplyInvulnerability(HealthHandler handler)
        {
            if (handler == null || InvulnerabilityDuration <= 0f)
            {
                return;
            }

            var component = handler.GetComponent<RespawnInvulnerabilityState>() ?? handler.gameObject.AddComponent<RespawnInvulnerabilityState>();
            component.Apply(InvulnerabilityDuration);
        }
    }

    internal class RespawnInvulnerabilityState : MonoBehaviour
    {
        private Coroutine invulnerabilityRoutine;
        private HealthHandler healthHandler;

        private void Awake()
        {
            healthHandler = GetComponent<HealthHandler>();
        }

        public void Apply(float duration)
        {
            if (healthHandler == null)
            {
                return;
            }

            if (invulnerabilityRoutine != null)
            {
                StopCoroutine(invulnerabilityRoutine);
            }

            invulnerabilityRoutine = StartCoroutine(InvulnerabilityTimer(duration));
        }

        private IEnumerator InvulnerabilityTimer(float duration)
        {
            healthHandler.isRespawning = true;

            float elapsed = 0f;
            while (elapsed < duration)
            {
                elapsed += TimeHandler.deltaTime;
                yield return null;
            }

            healthHandler.isRespawning = false;
            invulnerabilityRoutine = null;
        }
    }

    [Serializable]
    [HarmonyPatch(typeof(HealthHandler), nameof(HealthHandler.Revive))]
    internal class HealthHandlerRevivePatch
    {
        private static void Postfix(HealthHandler __instance)
        {
            RespawnInvulnerabilityManager.TryApplyInvulnerability(__instance);
        }
    }
}

